<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Getr√§nkeliste</title>
  <style>
    :root { font-family: system-ui, sans-serif; }
    body { max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
    h1 { margin-bottom: .25rem; }
    .grid { display: grid; gap: .5rem .75rem; align-items: center; }
    .hdr { font-weight: 600; border-bottom: 1px solid #ddd; padding-bottom: .25rem; margin-top: .5rem; }
    button { padding: .4rem .7rem; border-radius: .5rem; border: 1px solid #ccc; background: #f6f6f6; cursor: pointer; }
    button:hover { background: #eee; }
    .xs { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; letter-spacing: .15em; white-space: pre; }
    .row { padding: .25rem 0; border-bottom: 1px dashed #eee; }
    .totals { margin-top: 1rem; font-weight: 600; }
    .foot { color: #777; font-size: .9rem; margin-top: 1rem; }
    .ok { color: #0a0; }
    .err { color: #a00; }
    .toolbar { display: flex; gap: .5rem; align-items: center; margin: .5rem 0 1rem 0; flex-wrap: wrap; }
    input, select { padding: .35rem .5rem; border: 1px solid #ccc; border-radius: .5rem; }

    .stats { margin-top: .75rem; padding: .75rem; background:#f7f7f7; border:1px solid #e6e6e6; border-radius:.5rem; }
    .stats b { font-weight:700; }
  </style>
</head>
<body>
  <h1 style="display:flex; align-items:center; gap:1rem;">
    <img src="https://media04.meinbezirk.at/user/2011/02/22/6/8846_XXL.jpg"
         alt="Logo" style="height:50px; border-radius:8px;">
    Getr√§nkeliste - MSC Reserve
  </h1>

  <div class="toolbar">
    <label>Monat:
      <input id="ym" type="month" />
    </label>
    <button id="reload">Aktualisieren</button>
  </div>

  <!-- Auth-Block -->
  <div id="auth" class="toolbar">
    <label>Spieler:
      <select id="playerSel"></select>
    </label>
    <input id="pin" type="password" placeholder="PIN" />
    <button id="loginBtn">Login</button>
    <button id="logoutBtn" style="display:none;">Logout</button>
    <span id="whoami" class="xs"></span>
  </div>

  <div class="grid hdr" style="grid-template-columns: 1fr auto auto auto auto;">
    <div>Spieler</div>
    <div>Kosten</div>
    <div>Bier</div>
    <div>Limo</div>
    <div>Aktion</div>
  </div>

  <div id="list"></div>

  <div class="totals" id="totals"></div>
  <div id="funstats" class="foot"></div>
  <div id="status" class="foot"></div>

<script>
  // ---------- KONFIG ----------
  // HIER deine ver√∂ffentlichte Apps-Script Web-App URL einsetzen:
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxCSkRg0OsfL4omyRz21oQff6Rht4xSiNMqbwVyhlaUHkSs_T3p46dWevYBsYzRmKOD6Q/exec';

  const PLAYERS = [
    'Moschitz Nico','Domenik Aichholzer','Bernsteiner Markus','Blaschitz Fabian','Blaschitz Sebastian',
    'Demirci G√∂khan','Frank Elias','Ilic Danijel','Kerschbaumer Sandro','Koch Rene','K√§finger Michael',
    'Lackner Daniel','Lenuweit Marc','Lopez Fabio','Matanovic Anto','Modic Marko','Rexhaj Adrian',
    'Secardi Manuel','Seiwald Noel','Selmanovic Amir','Strasser Stefan','Thaqi Shemsedin',
    'Tschemernjak Fabian','Winkler Kevin','Winkler Pascal','Gotsiridze Gega','Fiebiger Sven',
    'CO-Trainer','ZADE'
  ];

  // ---------- Utils ----------
  const $  = sel => document.querySelector(sel);

  function ymNow() {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  }
  function formatYM(ym) {
    if (!ym) return '';
    const [y, m] = ym.split('-');
    const d = new Date(Number(y), Number(m) - 1);
    return d.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
  }

  // ---------- State & Preise ----------
  const state = { ym: null, sums: {}, me: null, token: null }; // me = Spielername
  const PRICES = { bier: 1.5, limo: 1.5 };
  const EUR = new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' });

  // ---------- Auth (Session) ----------
  function saveSession(player, token){
    try {
      localStorage.setItem('sess:player', player);
      localStorage.setItem('sess:token', token);
    } catch {}
    state.me = player;
    state.token = token;
    updateAuthUI();
  }
  function loadSession(){
    try {
      const p = localStorage.getItem('sess:player');
      const t = localStorage.getItem('sess:token');
      if (p && t){ state.me = p; state.token = t; }
    } catch {}
    updateAuthUI();
  }
  function clearSession(){
    try {
      localStorage.removeItem('sess:player');
      localStorage.removeItem('sess:token');
    } catch {}
    state.me = null; state.token = null;
    updateAuthUI(); render();
  }
  function updateAuthUI(){
    $('#logoutBtn').style.display = state.token ? '' : 'none';
    $('#loginBtn').style.display  = state.token ? 'none' : '';
    $('#playerSel').disabled = !!state.token;
    $('#pin').style.display = state.token ? 'none' : '';
    $('#whoami').textContent = state.token ? `eingeloggt: ${state.me}` : '';
  }
  function fillPlayerSelect(){
    const sel = $('#playerSel');
    sel.innerHTML = PLAYERS.map(n => `<option>${n}</option>`).join('');
  }

  function setStatus(msg, cls) {
    const el = document.getElementById('status');
    el.textContent = msg;
    el.className = 'foot ' + (cls || '');
  }

  function lockButton(btn, ms = 400) {
    if (!btn) return;
    btn.disabled = true;
    setTimeout(() => { btn.disabled = false; }, ms);
  }

  // ---------- Render ----------
  function render() {
    $('#ym').value = state.ym;

    const root = $('#list');
    root.innerHTML = '';
    const totals = { bier: 0, limo: 0, cost: 0 };

    PLAYERS.forEach(name => {
      const sum = state.sums[name] || { bier: 0, limo: 0 };
      const cost = sum.bier * PRICES.bier + sum.limo * PRICES.limo;

      totals.bier += sum.bier;
      totals.limo += sum.limo;
      totals.cost += cost;

      const row = document.createElement('div');
      row.className = 'grid row';
      row.style.gridTemplateColumns = "1fr auto auto auto auto";
      const isMe = state.me && name === state.me;

      row.innerHTML = `
        <div>${name}</div>
        <div>${EUR.format(cost)}</div>
        <div title="Bier">${sum.bier}</div>
        <div title="Limo">${sum.limo}</div>
        <div>
          ${isMe && state.token ? `
            <button data-drink="bier">+ Bier</button>
            <button data-drink="limo">+ Limo</button>
          ` : `<span class="xs">‚Äî</span>`}
        </div>`;
      root.appendChild(row);
    });

    $('#totals').innerHTML = `
      <div>Monat: ${formatYM(state.ym)}</div>
      <div>Bier: ${totals.bier}</div>
      <div>Limo: ${totals.limo}</div>
      <div>Gesamt: ${totals.bier + totals.limo} Getr√§nke</div>
      <div>Summe: ${EUR.format(totals.cost)}</div>
    `;

    renderFunStats();
  }

  function renderFunStats() {
    const rows = PLAYERS.map(p => {
      const s = state.sums[p] || { bier:0, limo:0 };
      return { name:p, bier:s.bier, limo:s.limo, total:s.bier + s.limo };
    });

    const maxBy = (arr, key) => {
      const vals = arr.map(o => o[key]);
      const max = Math.max(...vals, 0);
      return { value: max, items: arr.filter(o => o[key] === max) };
    };
    const minBy = (arr, key) => {
      if (!arr.length) return { value: 0, items: [] };
      const vals = arr.map(o => o[key]);
      const min = Math.min(...vals);
      return { value: min, items: arr.filter(o => o[key] === min) };
    };
    const names = xs => xs.map(x => x.name).join(', ') || '‚Äî';

    const mostTotal = maxBy(rows, 'total');
    const mostBier  = maxBy(rows, 'bier');
    const mostLimo  = maxBy(rows, 'limo');
    const leastTot  = minBy(rows, 'total');

    $('#funstats').innerHTML = `
      <div class="stats">
        <div>Am meisten getrunken in <b>${formatYM(state.ym)}</b> hat: <b>${names(mostTotal.items)}</b> (${mostTotal.value} Getr√§nke)</div>
        <div>Top ‚ÄûAlkoholiker‚Äú üç∫ und unser Bierkapit√§n: <b>${names(mostBier.items)}</b> (${mostBier.value} Bier)</div>
        <div>Bei der Limo am flei√üigsten ü•§: <b>${names(mostLimo.items)}</b> (${mostLimo.value} Limos)</div>
        <div>Am schlechtesten f√ºr die Mannschaftskasse üí∏: <b>${names(leastTot.items)}</b> (${leastTot.value} Getr√§nke)</div>
      </div>
    `;
  }

  // ---------- API ----------
  async function initMonth() {
    try {
      const r = await fetch(`${SCRIPT_URL}?action=months`);
      const { latest } = await r.json();
      state.ym = latest || ymNow();
    } catch {
      state.ym = ymNow();
    }
  }

  async function loadSums() {
    try {
      const r = await fetch(`${SCRIPT_URL}?action=sum&ym=${encodeURIComponent(state.ym)}`);
      const data = await r.json();
      if (data.ym) state.ym = data.ym;
      state.sums = data.sums || data;
      render();
      setStatus('Aktualisiert.', 'ok');
    } catch (e) {
      setStatus('Fehler beim Laden der Summen.', 'err');
    }
  }

  // ---------- Login/Logout ----------
  $('#loginBtn').addEventListener('click', async () => {
    const player = $('#playerSel').value;
    const code = $('#pin').value.trim();
    if (!player || !code) return setStatus('Bitte Spieler & PIN.', 'err');

    try{
      const r = await fetch(SCRIPT_URL, {
        method:'POST',
        headers:{'Content-Type':'text/plain'},
        body: JSON.stringify({ action:'login', player, code })
      });
      const j = await r.json();
      if (!j.ok) return setStatus(j.message || j.error || 'Login fehlgeschlagen.', 'err');
      saveSession(j.player, j.token);
      $('#pin').value = '';
      setStatus('Login erfolgreich.', 'ok');
      render();
    } catch(e){
      setStatus('Login Fehler: ' + e.message, 'err');
    }
  });

  $('#logoutBtn').addEventListener('click', () => {
    clearSession();
    setStatus('Abgemeldet.', 'ok');
  });

  // ---------- Buchen ----------
  async function addOne(drink, btnEl){
    if (!state.token){
      setStatus('Bitte zuerst einloggen.', 'err'); return;
    }
    if (!state.me){
      setStatus('Kein Spieler im Profil.', 'err'); return;
    }

    // Optimistisches Update nur f√ºr mich
    if (!state.sums[state.me]) state.sums[state.me] = { bier:0, limo:0 };
    const prev = { ...state.sums[state.me] };
    state.sums[state.me][drink]++;
    render();
    lockButton(btnEl);
    setStatus(`${state.me}: ${drink} gebucht (lokal)‚Ä¶`, 'ok');

    try{
      const r = await fetch(SCRIPT_URL, {
        method:'POST',
        headers:{ 'Content-Type':'text/plain' },
        body: JSON.stringify({ action:'book', token: state.token, drink, ym: state.ym })
      });
      const j = await r.json();
      if (!j.ok){
        state.sums[state.me] = prev; render();
        if (j.error === 'EXPIRED' || j.error === 'BAD_SIG' || j.error === 'BAD_FORMAT'){
          clearSession();
          setStatus('Session abgelaufen. Bitte neu einloggen.', 'err');
        } else {
          setStatus(j.message || 'Buchung abgelehnt.', 'err');
        }
        return;
      }
      setTimeout(loadSums, 250);
      setStatus(`${state.me}: ${drink} gebucht.`, 'ok');
    } catch(err){
      state.sums[state.me] = prev; render();
      setStatus(`Fehler beim Buchen: ${err.message}`, 'err');
    }
  }

  // ---------- Events ----------
  document.addEventListener('pointerdown', (ev) => {
    const btn = ev.target.closest('button[data-drink]');
    if (!btn) return;
    addOne(btn.getAttribute('data-drink'), btn);
  });

  document.getElementById('reload').addEventListener('click', () => {
    state.ym = document.getElementById('ym').value || ymNow();
    loadSums();
  });
  document.getElementById('ym').addEventListener('change', () => {
    state.ym = document.getElementById('ym').value || ymNow();
    loadSums();
  });

  // ---------- Init ----------
  (async function () {
    loadSession();
    fillPlayerSelect();
    await initMonth();
    await loadSums();
  })();
</script>

</body>
</html>
