<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Getr√§nkeliste</title>
  <style>
    :root { font-family: system-ui, sans-serif; }
    body { max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
    h1 { margin-bottom: .25rem; }
    .grid { display: grid; gap: .5rem .75rem; align-items: center; }
    .hdr { font-weight: 600; border-bottom: 1px solid #ddd; padding-bottom: .25rem; margin-top: .5rem; }
    button { padding: .4rem .7rem; border-radius: .5rem; border: 1px solid #ccc; background: #f6f6f6; cursor: pointer; }
    button:hover { background: #eee; }
    .xs { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; letter-spacing: .15em; white-space: pre; }
    .row { padding: .25rem 0; border-bottom: 1px dashed #eee; }
    .totals { margin-top: 1rem; font-weight: 600; }
    .foot { color: #777; font-size: .9rem; margin-top: 1rem; }
    .ok { color: #0a0; }
    .err { color: #a00; }
    .toolbar { display: flex; gap: .5rem; align-items: center; margin: .5rem 0 1rem 0; }
    input, select { padding: .35rem .5rem; border: 1px solid #ccc; border-radius: .5rem; }

    /* Fun-Stats Block */
    .stats { margin-top: .75rem; padding: .75rem; background:#f7f7f7; border:1px solid #e6e6e6; border-radius:.5rem; }
    .stats b { font-weight:700; }
  </style>
</head>
<body>
  <h1 style="display:flex; align-items:center; gap:1rem;">
    <img src="https://media04.meinbezirk.at/user/2011/02/22/6/8846_XXL.jpg"
         alt="Logo" style="height:50px; border-radius:8px;">
    Getr√§nkeliste - MSC Reserve
  </h1>

  <div class="toolbar">
    <label>Monat:
      <input id="ym" type="month" />
    </label>
    <button id="reload">Aktualisieren</button>
  </div>

  <div class="grid hdr" style="grid-template-columns: 1fr auto auto auto auto;">
    <div>Spieler</div>
    <div>Kosten</div>
    <div>Bier</div>
    <div>Limo</div>
    <div>Aktion</div>
  </div>

  <div id="list"></div>

  <div class="totals" id="totals"></div>
  <div id="funstats" class="foot"></div>
  <div id="status" class="foot"></div>

<script>
  // üëâ anpassen:
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwMWGny_leMJQduC7nEL_yHH3sbaCjJ2NsXf3YUGRE2VEvvM0iIxxWsx3TaSBI58aYmIg/exec';
  const PLAYERS = [
    'Moschitz Nico','Domenik Aichholzer','Bernsteiner Markus','Blaschitz Fabian','Blaschitz Sebastian',
    'Demirci G√∂khan','Frank Elias','Ilic Danijel','Kerschbaumer Sandro','Koch Rene','K√§finger Michael',
    'Lackner Daniel','Lenuweit Marc','Lopez Fabio','Matanovic Anto','Modic Marko','Rexhaj Adrian',
    'Secardi Manuel','Seiwald Noel','Selmanovic Amir','Strasser Stefan','Thaqi Shemsedin',
    'Tschemernjak Fabian','Winkler Kevin','Winkler Pascal','Gotsiridze Gega','Fiebiger Sven',
    'CO-Trainer','ZADE'
  ];

  const $  = sel => document.querySelector(sel);

  function ymNow() {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  }
  function formatYM(ym) {
    if (!ym) return '';
    const [y, m] = ym.split('-');
    const d = new Date(Number(y), Number(m) - 1);
    return d.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
  }

  // ---- State & Preise ----
  const state = { ym: null, sums: {} };
  const PRICES = { bier: 1.5, limo: 1.5 };
  const EUR = new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' });

  function render() {
    $('#ym').value = state.ym;

    const root = $('#list');
    root.innerHTML = '';
    const totals = { bier: 0, limo: 0, cost: 0 };

    PLAYERS.forEach(name => {
      const sum = state.sums[name] || { bier: 0, limo: 0 };
      const cost = sum.bier * PRICES.bier + sum.limo * PRICES.limo;

      totals.bier += sum.bier;
      totals.limo += sum.limo;
      totals.cost += cost;

      const row = document.createElement('div');
      row.className = 'grid row';
      row.style.gridTemplateColumns = "1fr auto auto auto auto"; // 5 Spalten wie Header
      row.innerHTML = `
        <div>${name}</div>
        <div>${EUR.format(cost)}</div>
        <div title="Bier">${sum.bier}</div>
        <div title="Limo">${sum.limo}</div>
        <div>
          <button data-name="${name}" data-drink="bier">+ Bier</button>
          <button data-name="${name}" data-drink="limo">+ Limo</button>
        </div>`;
      root.appendChild(row);
    });

    $('#totals').innerHTML = `
      <div>Monat: ${formatYM(state.ym)}</div>
      <div>Bier: ${totals.bier}</div>
      <div>Limo: ${totals.limo}</div>
      <div>Gesamt: ${totals.bier + totals.limo} Getr√§nke</div>
      <div>Summe: ${EUR.format(totals.cost)}</div>
    `;

    renderFunStats();
  }

  function renderFunStats() {
    const rows = PLAYERS.map(p => {
      const s = state.sums[p] || { bier:0, limo:0 };
      return { name:p, bier:s.bier, limo:s.limo, total:s.bier + s.limo };
    });

    const maxBy = (arr, key) => {
      const vals = arr.map(o => o[key]);
      const max = Math.max(...vals, 0);
      return { value: max, items: arr.filter(o => o[key] === max) };
    };
    const minBy = (arr, key) => {
      if (!arr.length) return { value: 0, items: [] };
      const vals = arr.map(o => o[key]);
      const min = Math.min(...vals);
      return { value: min, items: arr.filter(o => o[key] === min) };
    };
    const names = xs => xs.map(x => x.name).join(', ') || '‚Äî';

    const mostTotal = maxBy(rows, 'total');
    const mostBier  = maxBy(rows, 'bier');
    const mostLimo  = maxBy(rows, 'limo');
    const leastTot  = minBy(rows, 'total');

    $('#funstats').innerHTML = `
      <div class="stats">
        <div>Am meisten getrunken in <b>${formatYM(state.ym)}</b> hat: <b>${names(mostTotal.items)}</b> (${mostTotal.value} Getr√§nke)</div>
        <div>Top ‚ÄûAlkoholiker‚Äú üç∫: <b>${names(mostBier.items)}</b> (${mostBier.value} Bier)</div>
        <div>Bei der Limo am flei√üigsten ü•§: <b>${names(mostLimo.items)}</b> (${mostLimo.value} Limos)</div>
        <div>Am schlechtesten f√ºr die Mannschaftskasse üí∏: <b>${names(leastTot.items)}</b> (${leastTot.value} Getr√§nke)</div>
      </div>
    `;
  }

  function setStatus(msg, cls) {
    const el = document.getElementById('status');
    el.textContent = msg;
    el.className = 'foot ' + (cls || '');
  }

  // Button kurz sperren, um Spam zu bremsen
  function lockButton(btn, ms = 400) {
    if (!btn) return;
    btn.disabled = true;
    setTimeout(() => { btn.disabled = false; }, ms);
  }

  // --- PIN Handling (Client) ---
  function getStoredPin(name){
    try { return localStorage.getItem('pin:' + name) || null; } catch { return null; }
  }
  function storePin(name, pin){
    try { localStorage.setItem('pin:' + name, pin); } catch {}
  }
  function askForPin(name){
    const val = prompt(`PIN f√ºr ${name} eingeben:`);
    if (val === null) return null; // Abbruch
    const trimmed = String(val).trim();
    if (!trimmed) return null;
    return trimmed;
  }

  async function addOne(player, drink, btnEl) {
    // 0) PIN holen (aus localStorage oder prompt)
    let code = getStoredPin(player);
    if (!code){
      code = askForPin(player);
      if (!code){
        setStatus('Abgebrochen (kein PIN eingegeben).', 'err');
        return;
      }
    }

    // 1) Optimistisch hochz√§hlen
    if (!state.sums[player]) state.sums[player] = { bier: 0, limo: 0 };
    const prev = { ...state.sums[player] }; // f√ºr Rollback
    state.sums[player][drink]++;
    render();                 // sofort sichtbar
    lockButton(btnEl);
    setStatus(`${player}: ${drink} gebucht (lokal)‚Ä¶`, 'ok');

    // 2) Request
    try {
      const r = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ player, drink, ym: state.ym, code }),
        headers: { 'Content-Type': 'text/plain' }
      });
      const json = await r.json();
      if (!json.ok){
        // falscher PIN/gesperrt ‚Äì Rollback & evtl. neuen PIN abfragen
        state.sums[player] = prev;
        render();

        if (json.error === 'LOCKED'){
          const until = json.lockedUntil ? new Date(json.lockedUntil) : null;
          const t = until ? until.toLocaleString('de-DE') : 'sp√§ter';
          setStatus(`GESPERRT: ${player} bis ${t}.`, 'err');
          return;
        }
        if (json.error === 'BADPIN' || json.error === 'NOPIN'){
          // PIN aus localStorage l√∂schen und nochmal fragen
          try { localStorage.removeItem('pin:' + player); } catch {}
          setStatus(json.message || 'PIN falsch.', 'err');
          const retry = askForPin(player);
          if (!retry){
            setStatus('Buchung abgebrochen.', 'err');
            return;
          }
          // zweiter Versuch ohne Optimismus
          const r2 = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ player, drink, ym: state.ym, code: retry }),
            headers: { 'Content-Type': 'text/plain' }
          });
          const j2 = await r2.json();
          if (!j2.ok){
            if (j2.error === 'LOCKED'){
              const until = j2.lockedUntil ? new Date(j2.lockedUntil) : null;
              const t = until ? until.toLocaleString('de-DE') : 'sp√§ter';
              setStatus(`GESPERRT: ${player} bis ${t}.`, 'err');
            } else {
              setStatus(j2.message || 'Buchung fehlgeschlagen.', 'err');
            }
            return;
          }
          // Erfolg ‚Äì Summen nachladen, PIN merken
          storePin(player, retry);
          await loadSums();
          setStatus(`${player}: ${drink} gebucht.`, 'ok');
          return;
        }

        setStatus(json.message || 'Fehler beim Buchen.', 'err');
        return;
      }

      // Erfolg ‚Äì Summen nachladen, PIN ggf. merken
      storePin(player, code);
      setTimeout(loadSums, 250);
      setStatus(`${player}: ${drink} gebucht.`, 'ok');
    } catch (err) {
      // Rollback
      state.sums[player] = prev;
      render();
      setStatus(`Fehler beim Buchen: ${err.message}`, 'err');
    }
  }

  // ---- API ----
  async function initMonth() {
    try {
      const r = await fetch(`${SCRIPT_URL}?action=months`);
      const { latest } = await r.json();
      state.ym = latest || ymNow();
    } catch {
      state.ym = ymNow(); // Fallback
    }
  }

  async function loadSums() {
    try {
      const r = await fetch(`${SCRIPT_URL}?action=sum&ym=${encodeURIComponent(state.ym)}`);
      const data = await r.json();
      if (data.ym) state.ym = data.ym;
      state.sums = data.sums || data;
      render();
      setStatus('Aktualisiert.', 'ok');
    } catch (e) {
      setStatus('Fehler beim Laden der Summen.', 'err');
    }
  }

  // ---- Events ----
  document.addEventListener('pointerdown', (ev) => {
    const btn = ev.target.closest('button[data-name]');
    if (!btn) return;
    addOne(btn.getAttribute('data-name'), btn.getAttribute('data-drink'), btn);
  });

  // Monat wechseln
  document.getElementById('reload').addEventListener('click', () => {
    state.ym = document.getElementById('ym').value || ymNow();
    loadSums();
  });
  document.getElementById('ym').addEventListener('change', () => {
    state.ym = document.getElementById('ym').value || ymNow();
    loadSums();
  });

  // ---- Init ----
  (async function () {
    await initMonth();
    await loadSums();
  })();
</script>


</body>
</html>
