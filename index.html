
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Getr√§nkeliste</title>
  <style>
    :root { font-family: system-ui, sans-serif; }
    body { max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
    h1 { margin-bottom: .25rem; }
    .month { color: #555; margin-bottom: 1rem; }
    .grid { display: grid; grid-template-columns: 1fr auto auto auto; gap: .5rem .75rem; align-items: center; }
    .hdr { font-weight: 600; border-bottom: 1px solid #ddd; padding-bottom: .25rem; margin-top: .5rem; }
    button { padding: .4rem .7rem; border-radius: .5rem; border: 1px solid #ccc; background: #f6f6f6; cursor: pointer; }
    button:hover { background: #eee; }
    .xs { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; letter-spacing: .15em; white-space: pre; }
    .row { padding: .25rem 0; border-bottom: 1px dashed #eee; }
    .totals { margin-top: 1rem; font-weight: 600; }
    .foot { color: #777; font-size: .9rem; margin-top: 1rem; }
    .ok { color: #0a0; }
    .err { color: #a00; }
    .toolbar { display: flex; gap: .5rem; align-items: center; margin: .5rem 0 1rem 0; }
    input, select { padding: .35rem .5rem; border: 1px solid #ccc; border-radius: .5rem; }
  </style>
</head>
<body>
  <h1>Getr√§nkeliste</h1>
  <div class="month"></div>

  <div class="toolbar">
    <label>Monat:
      <input id="ym" type="month" />
    </label>
    <button id="reload">Aktualisieren</button>
  </div>

  <div class="grid hdr">
    <div>Spieler</div>
    <div>Bier</div>
    <div>Limo</div>
    <div>Aktion</div>
  </div>
  <div id="list"></div>

  <div class="totals" id="totals"></div>
  <div id="status" class="foot"></div>

<script>
  // üëâ anpassen:
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxZwIfIfFUJkCx81RCxiLbCSJ8bpCyB5cIMY02T-D3sENPb1OaOSafGutl09VyXr8VQow/exec';
  const PLAYERS = ['Anna','Ben','Chris','Dana','Erik','Franziska','Gabi','Hugo'];

  const $  = sel => document.querySelector(sel);

  function ymNow() {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  }
  function xString(n){ return 'X'.repeat(Math.min(n,50)); }

  // ---- EINZIGER state ----
  const state = { ym: null, sums: {} };

  function render() {
    $('#ym').value = state.ym ?? '';
    $('.month').textContent = `Monat: ${state.ym ?? '‚Äî'}`;

    const root = document.getElementById('list');
    root.innerHTML = '';
    const totals = { bier: 0, limo: 0 };

    PLAYERS.forEach(name => {
      const sum = state.sums[name] || { bier: 0, limo: 0 };
      totals.bier += sum.bier; totals.limo += sum.limo;

      const row = document.createElement('div');
      row.className = 'grid row';
      row.innerHTML = `
        <div>${name}</div>
        <div class="xs" title="${sum.bier}x Bier">${xString(sum.bier)}</div>
        <div class="xs" title="${sum.limo}x Limo">${xString(sum.limo)}</div>
        <div>
          <button data-name="${name}" data-drink="bier">+ Bier</button>
          <button data-name="${name}" data-drink="limo">+ Limo</button>
        </div>`;
      root.appendChild(row);
    });

    document.getElementById('totals').textContent =
      `Gesamt im ${state.ym}: Bier ${totals.bier} ¬∑ Limo ${totals.limo}`;
  }

  function setStatus(msg, cls) {
    const el = document.getElementById('status');
    el.textContent = msg;
    el.className = 'foot ' + (cls || '');
  }

  // ---- API ----
  async function initMonth() {
    try {
      const r = await fetch(`${SCRIPT_URL}?action=months`);
      const { latest } = await r.json();
      state.ym = latest || ymNow();
    } catch {
      state.ym = ymNow(); // Fallback
    }
  }

  async function loadSums() {
    try {
      const r = await fetch(`${SCRIPT_URL}?action=sum&ym=${encodeURIComponent(state.ym)}`);
      const data = await r.json();
      if (data.ym) state.ym = data.ym;           // falls Server selbst bestimmt
      state.sums = data.sums || data;            // r√ºckw√§rtskompatibel
      render();
      setStatus('Aktualisiert.', 'ok');
    } catch (e) {
      setStatus('Fehler beim Laden der Summen.', 'err');
    }
  }

  async function addOne(player, drink) {
    try {
      const body = JSON.stringify({ player, drink, ym: state.ym });
      const r = await fetch(SCRIPT_URL, {
        method: 'POST',
        body,
        headers: { 'Content-Type': 'text/plain' } // kein Preflight
      });
      const json = await r.json();
      if (!json.ok && json.error) throw new Error(json.error);

      // optimistisches Update
      if (!state.sums[player]) state.sums[player] = { bier: 0, limo: 0 };
      state.sums[player][drink]++;
      render();

      // danach die Wahrheit vom Server
      loadSums();
      setStatus(`${player}: ${drink} gebucht.`, 'ok');
    } catch (e) {
      setStatus('Fehler beim Buchen: ' + e.message, 'err');
    }
  }

  // ---- Events ----
  document.addEventListener('click', (ev) => {
    const btn = ev.target.closest('button[data-name]');
    if (!btn) return;
    addOne(btn.getAttribute('data-name'), btn.getAttribute('data-drink'));
  });

  document.getElementById('reload').addEventListener('click', () => {
    state.ym = document.getElementById('ym').value || ymNow();
    loadSums();
  });

  // ---- Init ----
  (async function () {
    await initMonth();  // setzt state.ym auf den letzten vorhandenen Monat
    await loadSums();   // l√§dt Summen f√ºr diesen Monat
  })();
</script>

</body>
</html>
